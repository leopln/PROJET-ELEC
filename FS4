#include <Arduino.h>
#include <Wire.h>
#include <Adafruit_GFX.h>
#include <Adafruit_SSD1306.h>

// ===================== OLED =====================
#define SCREEN_WIDTH 128
#define SCREEN_HEIGHT 64
Adafruit_SSD1306 display(SCREEN_WIDTH, SCREEN_HEIGHT, &Wire, -1);

// ===================== ENCODEUR SW2 =====================
// D'après le tableau du PCB : A -> D3, B -> D4, SW -> D2
const int PIN_ENC_A  = 3;   // A / CLK
const int PIN_ENC_B  = 4;   // B / DT
const int PIN_ENC_SW = 2;   // Bouton encodeur

// État précédent de A (CLK)
int lastClk = HIGH;

// --------- Protos ----------
void encoderInit();
int  readEncoderStep();  // -1, 0 ou +1
void afficherMessageScroll(const String &pseudo, const String &message);

// ===================== SETUP =====================
void setup() {
  Serial.begin(115200);
  Serial.println(F("FS4 – affichage + scroll (front descendant)"));

  Wire.begin();

  // Init OLED
  if (!display.begin(SSD1306_SWITCHCAPVCC, 0x3C)) {
    Serial.println(F("Echec init OLED"));
    while (1) {}
  }

  // Init encodeur
  encoderInit();

  // Petit écran de départ
  display.clearDisplay();
  display.setTextSize(1);
  display.setTextColor(SSD1306_WHITE);
  display.setCursor(0, 0);
  display.println(F("FS4 pret"));
  display.display();
  delay(800);
}

// ===================== LOOP =====================
void loop() {
  String pseudo  = "BipBoy";
  String message =
    "Salut ! Ceci est un long message pour tester FS4. "
    "On defile avec l'encodeur pour lire tout le texte, "
    "puis on quitte en appuyant sur le bouton.";

  afficherMessageScroll(pseudo, message);

  // Petite pause symbolique avant de relancer la demo
  delay(1000);
}

// ======================================================
//                GESTION ENCODEUR
// ======================================================

void encoderInit() {
  pinMode(PIN_ENC_A,  INPUT_PULLUP);
  pinMode(PIN_ENC_B,  INPUT_PULLUP);
  pinMode(PIN_ENC_SW, INPUT_PULLUP);
  lastClk = digitalRead(PIN_ENC_A);
}

/**
 * Lecture de l'encodeur avec déclenchement
 * uniquement sur le front DESCENDANT de A (HIGH -> LOW).
 *
 * Retourne :
 *   +1 : un cran dans un sens
 *   -1 : un cran dans l'autre sens
 *    0 : pas de cran détecté
 */
int readEncoderStep() {
  int step = 0;
  int clk  = digitalRead(PIN_ENC_A);

  // On ne regarde QUE le front descendant : HIGH -> LOW
  if (lastClk == HIGH && clk == LOW) {
    int dt = digitalRead(PIN_ENC_B);

    if (dt == HIGH) {
      step = +1;          // sens horaire
    } else {
      step = -1;          // sens anti-horaire
    }

    // Debug
    Serial.print(F("Step encodeur = "));
    Serial.println(step);
  }

  lastClk = clk;
  return step;
}

// ======================================================
//             FS4 : AFFICHAGE + SCROLL
// ======================================================

void afficherMessageScroll(const String &pseudo, const String &message) {
  const int CHARS_PER_LINE = 21;  // ≈ 21 caractères par ligne
  const int LINES_VISIBLE  = 4;   // 4 lignes visibles

  int len = message.length();
  if (len == 0) return;

  int totalLines = (len + CHARS_PER_LINE - 1) / CHARS_PER_LINE;
  int firstLine  = 0; // première ligne affichée

  bool lectureEnCours = true;

  Serial.println(F("Entree dans FS4"));

  while (lectureEnCours) {

    // 1) ENCODEUR → modification de la ligne de départ
    int step = readEncoderStep();
    if (step > 0 && firstLine < totalLines - LINES_VISIBLE) {
      firstLine++;
      Serial.print(F("firstLine = "));
      Serial.println(firstLine);
    } else if (step < 0 && firstLine > 0) {
      firstLine--;
      Serial.print(F("firstLine = "));
      Serial.println(firstLine);
    }

    // 2) BOUTON → quitter l’affichage
    if (digitalRead(PIN_ENC_SW) == LOW) {
      Serial.println(F("Bouton encodeur -> sortie FS4"));
      delay(200);         // anti-rebond
      lectureEnCours = false;
    }

    // 3) AFFICHAGE OLED
    display.clearDisplay();
    display.setTextSize(1);
    display.setTextColor(SSD1306_WHITE);

    // Bandeau haut : expéditeur (EF10)
    display.setCursor(0, 0);
    display.print(F("DE: "));
    display.println(pseudo);
    display.drawLine(0, 10, 128, 10, SSD1306_WHITE);

    // Corps du message (4 lignes)
    for (int i = 0; i < LINES_VISIBLE; i++) {
      int lineIdx = firstLine + i;
      if (lineIdx >= totalLines) break;

      int start = lineIdx * CHARS_PER_LINE;
      int end   = start + CHARS_PER_LINE;
      if (end > len) end = len;

      display.setCursor(0, 16 + i * 10); // y = 16, 26, 36, 46
      for (int j = start; j < end; j++) {
        display.print(message[j]);
      }
    }

    display.display();
    delay(5);   // laisse respirer le micro
  }
}
