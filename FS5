#include <Arduino.h>
#include <Wire.h>
#include <Adafruit_GFX.h>
#include <Adafruit_SSD1306.h>
#include <EEPROM.h>

// ================== HARDWARE ==================
#define SCREEN_WIDTH 128
#define SCREEN_HEIGHT 64
Adafruit_SSD1306 display(SCREEN_WIDTH, SCREEN_HEIGHT, &Wire, -1);

// Encodeur
#define PIN_CLK    3   // A
#define PIN_DT     4   // B
#define PIN_SW     2   // Bouton
// Buzzer
#define PIN_BUZZER 10

// ================== PARAMETRES FS5 ==================
// EF12 : canal radio (1..100)
int canal = 1;
// EF14 : sonnerie (1..3)
int son = 1;
// EF13 : pseudo (choisi dans la liste)
int pseudoIndex = 0;

const char* listePseudos[] = {
  "Editeur1",
  "Editeur2",
  "Editeur3",
  "Editeur4",
  "Editeur5"
};
const uint8_t NB_PSEUDOS = sizeof(listePseudos) / sizeof(listePseudos[0]);

// Etat du menu
int etatMenu = 0;  // 0 = menu principal, 1 = canal, 2 = pseudo, 3 = son
int curseur  = 1;  // 1..4

int lastClk = HIGH;

// ================== PROTOTYPES ==================
void afficherMenuPrincipal();
void reglerCanal();
void reglerPseudo();
void reglerSon();
int  lireEncodeur();
void bipTest();

// ================== SETUP ==================
void setup() {
  Serial.begin(115200);

  // OLED
  if (!display.begin(SSD1306_SWITCHCAPVCC, 0x3C)) {
    Serial.println("Echec init OLED");
    while (1) {}
  }
  display.clearDisplay();
  display.setTextSize(1);
  display.setTextColor(SSD1306_WHITE);
  display.display();

  // Encodeur + buzzer
  pinMode(PIN_CLK, INPUT_PULLUP);
  pinMode(PIN_DT,  INPUT_PULLUP);
  pinMode(PIN_SW,  INPUT_PULLUP);
  pinMode(PIN_BUZZER, OUTPUT);

  // ========= Chargement EEPROM (EF15) =========
  uint8_t v;

  v = EEPROM.read(0);              // canal sauvegardé
  if (v >= 1 && v <= 100) canal = v;
  else canal = 1;

  v = EEPROM.read(1);              // pseudo index
  if (v < NB_PSEUDOS) pseudoIndex = v;
  else pseudoIndex = 0;

  v = EEPROM.read(2);              // sonnerie
  if (v >= 1 && v <= 3) son = v;
  else son = 1;
}

// ================== LOOP ==================
void loop() {
  switch (etatMenu) {
    case 0: afficherMenuPrincipal(); break;
    case 1: reglerCanal();           break;
    case 2: reglerPseudo();          break;
    case 3: reglerSon();             break;
  }
}

// ================== FONCTIONS ==================

// ----- Menu principal -----
void afficherMenuPrincipal() {
  display.clearDisplay();
  display.setCursor(0, 0);
  display.println(F("--- MENU REGLAGES ---"));

  // Ligne 1 : Canal
  if (curseur == 1) display.print(F("> ")); else display.print(F("  "));
  display.print(F("Canal : "));
  display.println(canal);

  // Ligne 2 : Pseudo
  if (curseur == 2) display.print(F("> ")); else display.print(F("  "));
  display.print(F("Pseudo : "));
  display.println(listePseudos[pseudoIndex]);

  // Ligne 3 : Sonnerie
  if (curseur == 3) display.print(F("> ")); else display.print(F("  "));
  display.print(F("Son : "));
  display.println(son);

  // Ligne 4 : Quitter
  if (curseur == 4) display.print(F("> ")); else display.print(F("  "));
  display.println(F("Quitter"));

  display.display();

  int action = lireEncodeur();
  if (action == 1)  { curseur++; if (curseur > 4) curseur = 1; }
  if (action == -1) { curseur--; if (curseur < 1) curseur = 4; }

  if (action == 2) {              // clic
    if (curseur == 1) etatMenu = 1;
    else if (curseur == 2) etatMenu = 2;
    else if (curseur == 3) etatMenu = 3;
    else if (curseur == 4) {
      // petit message de sortie, paramètres déjà sauvegardés
      display.clearDisplay();
      display.setCursor(0, 20);
      display.println(F("Parametres OK"));
      display.display();
      delay(1000);
      // ensuite tu pourras revenir au "programme principal"
    }
  }
}

// ----- Réglage canal (EF12) -----
void reglerCanal() {
  display.clearDisplay();
  display.setCursor(0, 0);
  display.println(F("Canal radio (1-100)"));
  display.setTextSize(2);
  display.setCursor(40, 30);
  display.print(canal);
  display.setTextSize(1);
  display.display();

  int action = lireEncodeur();
  if (action == 1 && canal < 100) canal++;
  if (action == -1 && canal > 1)  canal--;

  if (action == 2) {            // validation
    EEPROM.write(0, canal);     // EF15 : mémorisation
    etatMenu = 0;
  }
}

// ----- Réglage pseudo (EF13) -----
void reglerPseudo() {
  display.clearDisplay();
  display.setCursor(0, 0);
  display.println(F("Choix du pseudo"));

  display.setTextSize(2);
  display.setCursor(10, 30);
  display.print(listePseudos[pseudoIndex]);
  display.setTextSize(1);
  display.display();

  int action = lireEncodeur();
  if (action == 1 && pseudoIndex < NB_PSEUDOS - 1) pseudoIndex++;
  if (action == -1 && pseudoIndex > 0)             pseudoIndex--;

  if (action == 2) {
    EEPROM.write(1, pseudoIndex);   // EF15
    etatMenu = 0;
  }
}

// ----- Réglage type de son (EF14) -----
void reglerSon() {
  display.clearDisplay();
  display.setCursor(0, 0);
  display.println(F("Type sonnerie (1-3)"));
  display.setTextSize(2);
  display.setCursor(60, 30);
  display.print(son);
  display.setTextSize(1);
  display.display();

  int action = lireEncodeur();
  if (action == 1 && son < 3)  { son++; bipTest(); }
  if (action == -1 && son > 1) { son--; bipTest(); }

  if (action == 2) {
    EEPROM.write(2, son);       // EF15
    etatMenu = 0;
  }
}

// ----- Petit bip d'aperçu -----
void bipTest() {
  if (son == 1)      tone(PIN_BUZZER, 1000, 120);
  else if (son == 2) tone(PIN_BUZZER, 2000, 120);
  else if (son == 3) tone(PIN_BUZZER, 600,  180);
}

// ----- Lecture très simple de l’encodeur -----
int lireEncodeur() {
  int resultat   = 0;
  int currentClk = digitalRead(PIN_CLK);

  // rotation
  if (currentClk != lastClk && currentClk == LOW) {
    if (digitalRead(PIN_DT) != currentClk) resultat = 1;   // sens horaire
    else                                   resultat = -1;  // sens anti-horaire
  }
  lastClk = currentClk;

  // clic
  if (digitalRead(PIN_SW) == LOW) {
    delay(180);    // anti-rebond simple
    resultat = 2;
  }

  return resultat;
}
