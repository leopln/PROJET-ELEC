#include <SPI.h>
#include <nRF24L01.h>
#include <RF24.h>

// --- Configuration Matérielle  ---
#define PIN_CE  7
#define PIN_CSN 8

RF24 radio(PIN_CE, PIN_CSN);

// Adresse du canal de communication 
const byte address[6] = "00001"; 

// --- Variables Globales ---
String monPseudo = "Expéditeur"; // Exemple de pseudo (EF13)

void setup() {
  Serial.begin(9600);
  
  // Initialisation du NRF24
  if (!radio.begin()) {
    Serial.println(F("Erreur: Radio non connectée !"));
    while (1);
  }

  radio.openWritingPipe(address); // Ouvre le canal en écriture
  radio.setPALevel(RF24_PA_LOW);  // Puissance basse pour les tests sur table
  radio.stopListening();          // Important : se mettre en mode émission
}

void loop() {
  // Simulation d'un envoi (normalement déclenché par FS1)
  // Ici on envoie un message de test toutes les 5 secondes
  String messageAEnvoyer = "Ceci est un message tres long pour tester la fragmentation du protocole FS2 car le NRF24 est limite a 32 octets.";
  
  FS2_EnvoyerMessage(messageAEnvoyer, monPseudo);
  
  delay(5000);
}

/**
 * FS2 : Fonction pour envoyer un message complet
 * Gère la fragmentation des données > 32 octets [cite: 67]
 */
void FS2_EnvoyerMessage(String message, String pseudo) {
  
  Serial.println(F("--- Début envoi FS2 ---"));
  
  // Etape 1 : Envoyer le Pseudo (EF5) 
  // On crée un préfixe pour dire "Ceci est le pseudo"
  char headerPayload[32] = "";
  String header = "FROM:" + pseudo;
  header.toCharArray(headerPayload, 32);
  
  radio.write(&headerPayload, sizeof(headerPayload));
  delay(50); // Petit délai pour laisser le récepteur traiter

  // Etape 2 : Envoyer le corps du message découpé (EF4) 
  int messageLength = message.length();
  int position = 0;

  while (position < messageLength) {
    char chunkBuffer[32] = ""; // Tampon de 32 octets max 
    
    // On extrait un morceau de 32 caractères 
    
    String chunk = message.substring(position, min(position + 32, messageLength));
    chunk.toCharArray(chunkBuffer, 32);

    // Envoi radio
    bool report = radio.write(&chunkBuffer, sizeof(chunkBuffer));
    
    if (report) {
      Serial.print(F("Paquet envoyé : "));
      Serial.println(chunkBuffer);
    } else {
      Serial.println(F("Echec envoi paquet !"));
    }

    position += 32; // On avance au bloc suivant
    delay(50);      // Délai pour stabilité
  }
  
  // Etape 3 : Signaler la fin du message
  
  char endMarker[] = "END";
  radio.write(&endMarker, sizeof(endMarker));
  
  Serial.println(F("--- Message complet envoyé ---"));
}
